<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Community Fridge Map</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body class="bg-gray-100">
{% include "components/navbar.html.jinja" %}

<div class="flex h-screen">

    <!-- Sidebar -->
    <div class="w-1/3 bg-white shadow-lg overflow-y-auto p-4">
        <h2 class="text-2xl font-bold mb-4">
            Nearby Community Fridges
        </h2>

        <ul id="fridge-list" class="space-y-3"></ul>
    </div>

    <!-- Map -->
    <div id="map" class="w-2/3"></div>

</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

// Initialize map (default view NYC)
var map = L.map('map').setView([40.7128, -74.0060], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = {};
const list = document.getElementById("fridge-list");

// Haversine distance formula
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Get user's GPS location
navigator.geolocation.getCurrentPosition(

    position => {

        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;

        map.setView([userLat, userLng], 13);

        // User marker
        L.marker([userLat, userLng])
            .addTo(map)
            .bindPopup("You are here");

        loadFridges(userLat, userLng);
    },

    error => {
        alert("Location access denied. Showing default area.");
        loadFridges(40.7128, -74.0060);
    }

);

function loadFridges(userLat, userLng) {

    fetch('/get-fridges')
    .then(res => res.json())
    .then(data => {

        data.forEach(fridge => {
            fridge.distance = getDistance(
                userLat,
                userLng,
                fridge.lat,
                fridge.lng
            );
        });

        // Sort nearest first
        data.sort((a, b) => a.distance - b.distance);

        list.innerHTML = "";

        data.forEach(fridge => {

            const marker = L.marker([fridge.lat, fridge.lng])
                .addTo(map)
                .bindPopup(`
                    <b>${fridge.name}</b>
                    <br>Status: ${fridge.status}
                    <br>${fridge.distance.toFixed(2)} km away
                `);

            markers[fridge.id] = marker;

            const li = document.createElement("li");
            li.className = "p-3 bg-gray-50 rounded-lg shadow hover:bg-gray-200 cursor-pointer";

            li.innerHTML = `
                <div class="font-semibold">${fridge.name}</div>
                <div class="text-sm text-gray-600">
                    ${fridge.distance.toFixed(2)} km away
                </div>
            `;

            li.addEventListener("click", () => {
                map.setView([fridge.lat, fridge.lng], 15);
                marker.openPopup();
            });

            list.appendChild(li);
        });

    });
}

</script>


{% include "components/footer.html.jinja" %}
</body>
</html>